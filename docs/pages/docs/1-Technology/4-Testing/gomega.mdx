---
sidebar_position: 4
title: "Gomega"
---

import PageHeader from '@site/src/components/PageHeader';
import FeatureCard from '@site/src/components/FeatureCard';
import CardGrid from '@site/src/components/CardGrid';
import InfoSection from '@site/src/components/InfoSection';
import FeatureGrid from '@site/src/components/FeatureGrid';
import NoAutoTitle from '@site/src/components/NoAutoTitle';

<NoAutoTitle />

<PageHeader 
  title="Gomega"
  description="Expressive matcher/assertion library for Go"
/>

[Gomega](https://github.com/onsi/gomega) is a matcher and assertion library for Go, commonly used with Ginkgo for BDD-style testing in the Control Plane.

<InfoSection type="info" title="Expressive assertions">
  Gomega provides a fluent, expressive syntax for making assertions in tests, making tests both more readable and more maintainable.
</InfoSection>

## Overview

Gomega enhances Go tests with readable assertions and powerful matching capabilities. While it's designed to work seamlessly with Ginkgo, it can also be used with Go's standard testing package.

<FeatureGrid columns={2} features={[
  {
    title: "🔍 Expressive Matchers",
    description: "Clear, readable syntax for assertions with detailed failure messages."
  },
  {
    title: "⏱️ Asynchronous Testing",
    description: "Built-in support for testing asynchronous behavior with Eventually and Consistently."
  },
  {
    title: "🔄 Custom Matchers",
    description: "Ability to create custom matchers for domain-specific assertions."
  },
  {
    title: "🧩 Combinable Matchers",
    description: "Combine matchers with And, Or, and Not for complex assertions."
  },
  {
    title: "🌐 Collection Matchers",
    description: "Special matchers for arrays, slices, maps, and channels."
  },
  {
    title: "⚙️ Error Handling",
    description: "Specific matchers for error handling and propagation."
  }
]} />

## Integration in the Control Plane

<InfoSection type="tip" title="Consistent assertions">
  Gomega provides a consistent way to express expectations across the Control Plane codebase, making tests more readable and maintainable.
</InfoSection>

The Control Plane uses Gomega for assertions in various types of tests:

<CardGrid columns={2}>
  <FeatureCard
    title="Unit Tests"
    description={<>
      <p>Basic assertions for functions and methods:</p>
      <ul>
        <li>Verifying return values</li>
        <li>Checking error conditions</li>
        <li>Validating data transformations</li>
        <li>Testing boundary conditions</li>
      </ul>
    </>}
  />
  
  <FeatureCard
    title="Controller Tests"
    description={<>
      <p>Assertions for controller behavior:</p>
      <ul>
        <li>Resource creation and updates</li>
        <li>Status field changes</li>
        <li>Reconciliation results</li>
        <li>Error handling and recovery</li>
      </ul>
    </>}
  />
</CardGrid>

## Basic Usage

Gomega provides a fluent API for assertions:

```go
package example_test

import (
    "testing"

    . "github.com/onsi/gomega"
)

func TestExample(t *testing.T) {
    g := NewWithT(t)
    
    // Simple equality
    g.Expect(42).To(Equal(42))
    
    // String matching
    g.Expect("hello world").To(ContainSubstring("hello"))
    
    // Numeric comparisons
    g.Expect(10).To(BeNumerically(">", 5))
    
    // Error checking
    result, err := SomeFunctionThatMightError()
    g.Expect(err).NotTo(HaveOccurred())
    g.Expect(result).To(BeTrue())
    
    // Nil checking
    g.Expect(somePointer).NotTo(BeNil())
}
```

### With Ginkgo

Gomega is commonly used with Ginkgo in the Control Plane:

```go
package example_test

import (
    . "github.com/onsi/ginkgo/v2"
    . "github.com/onsi/gomega"
)

var _ = Describe("FileManager", func() {
    It("should create a new file", func() {
        fileManager := NewFileManager()
        err := fileManager.CreateFile("test.txt", []byte("content"))
        
        Expect(err).NotTo(HaveOccurred())
        Expect(fileManager.FileExists("test.txt")).To(BeTrue())
    })
})
```

## Common Matchers

<InfoSection type="note" title="Expressive assertions">
  Gomega provides a rich set of matchers that make tests both readable and precise.
</InfoSection>

<CardGrid columns={3}>
  <FeatureCard
    title="Equality Matchers"
    description={<>
      <code>{`Equal(expected)`}</code>: Deep equality<br/>
      <code>{`BeIdenticalTo(expected)`}</code>: Pointer identity<br/>
      <code>{`BeEquivalentTo(expected)`}</code>: Type-converting equality<br/>
    </>}
  />
  
  <FeatureCard
    title="Comparison Matchers"
    description={<>
      <code>{`BeNumerically(">", 5)`}</code>: Numeric comparison<br/>
      <code>{`BeLessThan(10)`}</code>: Less than<br/>
      <code>{`BeGreaterThan(5)`}</code>: Greater than<br/>
    </>}
  />
  
  <FeatureCard
    title="Boolean Matchers"
    description={<>
      <code>{`BeTrue()`}</code>: Is true<br/>
      <code>{`BeFalse()`}</code>: Is false<br/>
      <code>{`BeTruthy()`}</code>: Evaluates to true<br/>
    </>}
  />
  
  <FeatureCard
    title="Error Matchers"
    description={<>
      <code>{`HaveOccurred()`}</code>: Non-nil error<br/>
      <code>{`Succeed()`}</code>: Nil error<br/>
      <code>{`MatchError(expected)`}</code>: Error matching<br/>
    </>}
  />
  
  <FeatureCard
    title="String Matchers"
    description={<>
      <code>{`ContainSubstring("foo")`}</code>: Contains substring<br/>
      <code>{`HavePrefix("foo")`}</code>: Has prefix<br/>
      <code>{`MatchRegexp("\\d+")`}</code>: Matches regexp<br/>
    </>}
  />
  
  <FeatureCard
    title="Collection Matchers"
    description={<>
      <code>{`HaveLen(3)`}</code>: Has length<br/>
      <code>{`ContainElement("foo")`}</code>: Contains element<br/>
      <code>{`HaveKey("foo")`}</code>: Map has key<br/>
    </>}
  />
</CardGrid>

## Asynchronous Testing

<InfoSection type="tip" title="Testing async behavior">
  Gomega's Eventually and Consistently functions are particularly useful for testing controllers in the Control Plane, which often involve asynchronous reconciliation loops.
</InfoSection>

```go
// Wait for a condition to be true
Eventually(func() bool {
    return fileManager.IsReady()
}).Should(BeTrue())

// With timeout and polling interval
Eventually(func() error {
    return k8sClient.Get(ctx, key, resource)
}).WithTimeout(5*time.Second).WithPolling(100*time.Millisecond).Should(Succeed())

// Ensure a condition remains true
Consistently(func() int {
    return queue.Length()
}).WithTimeout(1*time.Second).Should(Equal(0))
```

## Custom Matchers

The Control Plane uses custom matchers for domain-specific assertions:

```go
// Define a custom matcher
type HaveStatusMatcher struct {
    Expected string
}

func (matcher *HaveStatusMatcher) Match(actual interface{}) (success bool, err error) {
    resource, ok := actual.(*apiv1.MyResource)
    if !ok {
        return false, fmt.Errorf("HaveStatus matcher expects a MyResource")
    }
    return resource.Status.State == matcher.Expected, nil
}

func (matcher *HaveStatusMatcher) FailureMessage(actual interface{}) string {
    resource := actual.(*apiv1.MyResource)
    return fmt.Sprintf("Expected resource to have status %s but got %s", 
        matcher.Expected, resource.Status.State)
}

func (matcher *HaveStatusMatcher) NegatedFailureMessage(actual interface{}) string {
    resource := actual.(*apiv1.MyResource)
    return fmt.Sprintf("Expected resource not to have status %s", matcher.Expected)
}

// Usage function
func HaveStatus(status string) types.GomegaMatcher {
    return &HaveStatusMatcher{Expected: status}
}

// In a test
Expect(myResource).To(HaveStatus("Ready"))
```

## Advanced Features

<InfoSection type="note" title="Powerful assertions">
  Gomega includes advanced features that make complex assertions straightforward.
</InfoSection>

<CardGrid columns={2}>
  <FeatureCard
    title="Combining Matchers"
    description={<>
      <code>{`And(BeNumerically(">", 5), BeNumerically("<", 10))`}</code><br/>
      <code>{`Or(Equal("foo"), Equal("bar"))`}</code><br/>
      <code>{`Not(Equal("baz"))`}</code>
    </>}
  />
  
  <FeatureCard
    title="Transform Support"
    description={<>
      <code>{`Transform(func(s string) int { return len(s) }, Equal(5))`}</code><br/>
      For complex data extraction before matching
    </>}
  />
  
  <FeatureCard
    title="Handling Channels"
    description={<>
      <code>{`Eventually(channel).Should(Receive())`}</code><br/>
      <code>{`Eventually(channel).Should(BeClosed())`}</code><br/>
      <code>{`Eventually(channel).Should(Receive(Equal("expected")))`}</code>
    </>}
  />
  
  <FeatureCard
    title="Handling Panics"
    description={<>
      <code>{`Expect(func() { panic("boom!") }).To(Panic())`}</code><br/>
      <code>{`Expect(func() { panic("boom!") }).To(PanicWith("boom!"))`}</code>
    </>}
  />
</CardGrid>

## Best Practices in the Control Plane

<FeatureGrid columns={2} features={[
  {
    title: "📝 Descriptive Assertions",
    description: "Write assertions that clearly convey intent and provide meaningful failure messages."
  },
  {
    title: "🔄 Eventually with Timeouts",
    description: "Always specify reasonable timeouts for Eventually assertions to prevent long-running tests."
  },
  {
    title: "🧩 Custom Domain Matchers",
    description: "Create custom matchers for domain-specific concepts to make tests more readable."
  },
  {
    title: "♻️ Reuse Complex Assertions",
    description: "Extract complex assertions into helper functions for reuse and clarity."
  },
  {
    title: "⚠️ Avoid Over-Specificity",
    description: "Focus on testing behavior rather than implementation details to create more maintainable tests."
  },
  {
    title: "🔍 Targeted Assertions",
    description: "Test one concept per assertion for clearer failure messages and better test diagnostics."
  }
]} />

## Related Resources

<CardGrid columns={2}>
  <FeatureCard
    title="Ginkgo"
    description="BDD-style testing framework that pairs perfectly with Gomega."
    linkText="View Ginkgo"
    linkUrl="ginkgo"
  />
  
  <FeatureCard
    title="Testify"
    description="Another testing toolkit used in the Control Plane."
    linkText="View Testify"
    linkUrl="testify"
  />
  
  <FeatureCard
    title="Go-Snaps"
    description="Snapshot testing library for Go applications."
    linkText="View Go-Snaps"
    linkUrl="go-snaps"
  />
</CardGrid>